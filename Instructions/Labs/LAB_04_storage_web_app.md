---
lab:
  title: '演習 04: 新しい会社アプリ用のストレージを提供する'
  module: Guided Project - Azure Files and Azure Blobs
---
会社は、新しいアプリの設計と開発を行っています。 開発者は、キーとマネージド ID のみを使用してストレージにアクセスできるようにする必要があります。 開発者は、ロールベースのアクセス制御を使用したいと考えています。 テストを支援するには、保護された不変ストレージが必要です。 

## アーキテクチャ ダイアグラム

![ストレージ アカウント、マネージド ID、キー コンテナーを示す図。](../Media/task-5.png)

## スキルアップ タスク

- ストレージ アカウントとマネージド ID を作成します。
- キー コンテナーとキーを使用してストレージ アカウントへのアクセスをセキュリティで保護します。
- キー コンテナー内のカスタマー マネージド キーを使用するようにストレージ アカウントを構成します。
- 時間ベースのアイテム保持ポリシーと暗号化スコープを構成します。

## 演習の手順

## ストレージ アカウントとマネージド ID を作成します

1. Web アプリ用のストレージ アカウントを提供します。 
    - ポータルで、「**ストレージ アカウント**」と検索して選択します。 
    - **[+ 作成]** を選択します。
    - **リソース グループ**で既存のリソースグループを選択します。
    - **[ストレージ アカウント名]** を指定します。 名前が一意であり、名前付け要件を満たしていることを確認します。 
    - **確認**して、ストレージ アカウントを**作成**します。
    - リソースがデプロイされるまで待ちます。

1. Web アプリが使用するマネージド ID を提供します。  [マネージド ID](https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview) に関する詳細を確認します。

    - **マネージド ID** を検索して選択します。
    - **［作成］** を選択します
        - **リソース グループ**を選択します。 
        - マネージド ID に名前を付けます。
    - **[確認と作成]** を選択してから、**[作成]** を選択します。 

1. マネージド ID に正しいアクセス許可を割り当てます。 ID には、コンテナーと BLOB の読み取りと一覧表示のみが必要です。 [Azure ロールの割り当て方法](https://learn.microsoft.com/azure/role-based-access-control/role-assignments-portal)に関する詳細を確認します。
    
    - 「**ストレージ アカウント**」を検索して選択します。
    - **[アクセス制御 (IAM)]** ブレードを選択します。
    - ページの中央で、**[ロールの割り当ての追加]** を選択します。
    - **[職務のロール]** ページで、**ストレージ BLOB データ閲覧者** ロールを検索して選択します。 
    - **[メンバー]** ページで、**[マネージド ID]** を選択します。
    - **[メンバーの選択]** を選択し、**[マネージド ID]** ドロップダウンで **[ユーザー割り当てマネージド ID]** を選択します。
    - 前の手順で作成したマネージド ID を選択します。 
    - **[選択]** をクリックし、 **[レビューと割り当て]** をクリックします。 
    - もう一度 **[レビューと割り当て]** を選択し、ロールの割り当てを追加します。
    - ストレージ アカウントは、ストレージ データ BLOB 閲覧者のアクセス許可を持つマネージド ID によってアクセスできるようになりました。 

## キー コンテナーとキーを使用してストレージ アカウントへのアクセスをセキュリティで保護します

1. ラボのこの部分に必要なキー コンテナーとキーを作成するには、ユーザー アカウントに Key Vault 管理者のアクセス許可が必要です。 [Azure のロールベースのアクセス制御を使用して Key Vault のキー、証明書、シークレットへのアクセス権を付与する](https://learn.microsoft.com/azure/key-vault/general/rbac-guide?tabs=azure-cli)方法に関する詳細を確認します。
    - ポータルで、「**リソース グループ**」を検索して選択します。 
    - **リソース グループ**を選択し、**[アクセス制御 (IAM)]** ブレードを選択します。
    - ページの中央で、**[ロールの割り当ての追加]** を選択します。
    - **[職務のロール]** ページで、「**キー コンテナー管理者**」 ロールを検索して選択します。
    - **[メンバー]** ページで、**[ユーザー、グループ、またはサービス プリンシパル]** を選択します。
    - **[メンバーの選択]** を選択します。
    - 自身の「ユーザー アカウント」を検索して選択します。 ユーザー アカウントはポータルの右上に表示されます。
    - **[選択]**、**[レビューと割り当て]** の順にクリックします。
    - もう一度 **[レビューと割り当て]** を選択し、ロールの割り当てを追加します。
    - これで、ラボを続行する準備が整いました。

1. アクセス キーを格納するキー コンテナーを作成します。 

    - ポータルで、「**キー コンテナー**」を検索して選択します。
    - **［作成］** を選択します
    - **リソース グループ**を選択します。
    - キー コンテナーの**名前**を指定します。 名前は一意である必要があります。
    - **[アクセス構成]** タブで、**[Azure ロールベースのアクセス制御 (推奨)]** が選択されていることを確認します。 
    - **[Review + create](確認及び作成)** を選択します。
    - 検証チェックが完了するまで待ってから、**[作成]** を選択します。
    - デプロイ後、**[リソースに移動]** を選択します。
    - **[概要]** ブレードで、**論理的な削除**と**消去**の両方の保護が**有効**になっていることを確認します。 

1. キー コンテナーにカスタマー マネージド キーを作成します。 

    - **キー コンテナー**の **[オブジェクト]** セクションで、**[キー]** ブレードを選択します。
    - **[生成/インポート]** を選択し、キーに**名前**を付けます。
    - 残りのパラメーターについては既定値を使用し、**[作成]** をクリックしてキーを作成します。

## キー コンテナー内のカスタマー マネージド キーを使用するようにストレージ アカウントを構成します。

1. 次の手順を完了する前に、Key Vault Crypto サービス暗号化ユーザー ロールをマネージド ID に割り当てる必要があります。 [システム割り当てマネージド ID を使用してアクセスを承認する方法](https://learn.microsoft.com/azure/storage/common/customer-managed-keys-configure-existing-account?tabs=azure-portal#use-a-system-assigned-managed-identity-to-authorize-access)に関する詳細を確認します
    - ポータルで、「**リソース グループ**」を検索して選択します。 
    - **リソース グループ**を選択し、**[アクセス制御 (IAM)]** ブレードを選択します。
    - ページの中央で、**[ロールの割り当ての追加]** を選択します。
    - **[職務のロール]** ページで、「**キー コンテナー暗号化ユーザー**」ロールを検索して選択します。
    - **[メンバー]** ページで、**[マネージド ID]** を選択します。
    - **[メンバーの選択]** を選択し、**[マネージド ID]** ドロップダウンで **[ユーザー割り当てマネージド ID]** を選択します。
    - [マネージド ID] を選択します。  
    - **[選択]**、**[確認と割り当て]** の順にクリックします。
    - もう一度 **[確認と割り当て]** を選択し、ロールの割り当てを追加します。
    
1. キー コンテナー内のカスタマー マネージド キーを使用するようにストレージ アカウントを構成します。 [既存のストレージ アカウントのカスタマー マネージド キー](https://learn.microsoft.com/azure/storage/common/customer-managed-keys-configure-existing-account?WT.mc_id=Portal-Microsoft_Azure_Storage&tabs=azure-portal)に関する詳細を確認します。
    - 自分のストレージ アカウントに戻ります。
    - **[セキュリティとネットワーク]** セクションで、**[暗号化]** ブレードを選択します。
    - **[カスタマー マネージド キー]** を選択します。
    - **キー コンテナーとキーを選択します**。 キー コンテナーとキーを選択します。
    - **選択**して選択を確定します。 
    - **[ID の種類]** が **[ユーザー割り当て]** であることを確認します。
    - **ID を選択します**。
    - マネージド ID を選択し、**[追加]** を選択します。 
    - 変更内容を**保存**します。
    - ID に正しいアクセス許可がないというエラーが表示された場合は、少し待ってからやり直してください。 

## 時間ベースのアイテム保持ポリシーと暗号化スコープを構成します。

1. 開発者は、管理者であってもファイルを変更できないストレージ コンテナーを必要としています。 [BLOB 不変ストレージ](https://learn.microsoft.com/azure/storage/blobs/immutable-storage-overview)に関する詳細を確認します。

    - **ストレージ アカウント**に移動します。
    - **[データ ストレージ]** セクションで、**[コンテナー]** ブレードを選択します。 
    - **hold** という名前のコンテナーを作成します。 既定値のままにします。 必ずコンテナーを **作成** してください。 
    - ファイルをコンテナーにアップロードします。 
    - **[設定]** セクションで、**[アクセス ポリシー]** ブレードを選択します。 
    - **[不変 BLOB ストレージ]** セクションで、**[+ ポリシーの追加]** を選択します。 
    - **[ポリシーの種類]** では、**[時間ベースの保持]** を選択します。 
    - **[保持期間]** を **5** 日に設定します。 
    - 変更を必ず**保存**してください。 
    - コンテナー内のファイルを**削除**してみてください。 
    - ポリシーが原因で **BLOB の削除に失敗したこと**が通知されたことを確認します。  

1. 開発者は、インフラストラクチャの暗号化を有効にする暗号化スコープを必要としています。 [インフラストラクチャの暗号化](https://learn.microsoft.com/azure/storage/common/infrastructure-encryption-enable?tabs=portal)に関する詳細を確認します。

    - ストレージ アカウントに戻ります。 
    - **[セキュリティとネットワーク]** ブレードで、**[暗号化]** を選択します。
    - **[暗号化スコープ]** タブで、**[追加]** を選択します。
    - 暗号化スコープに**名前**を付けます。 
    - **暗号化の種類**は、**Microsoft マネージド キー**です。
    - **インフラストラクチャの暗号化**を **[有効]** に設定します。
    - スコープの作成後にインフラストラクチャ暗号化を有効にすることはできませんという警告に注意してください。
    - 暗号化スコープを**作成**します。
    - ストレージ アカウントに戻り、新しいコンテナーを作成します。
    - **[新しいコンテナー]** ページに、**名前**と**パブリック アクセス レベル**があることを確認します。
    - **[詳細設定]** セクションで、作成した**暗号化スコープ**を選択し、コンテナー内のすべての BLOB に適用できます。 


>**注**: 追加の演習については、「[ネットワーク セキュリティ グループとサービス エンドポイントを使うことで Azure リソースへのアクセスをセキュリティで保護し、分離する](https://learn.microsoft.com/training/modules/secure-and-isolate-with-nsg-and-service-endpoints/)」モジュールを完了してください。 このモジュールにはサンドボックスがあり、ストレージへのアクセスを制限する演習をさらに行うことができます。
